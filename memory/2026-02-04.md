# 2026-02-04 Memory

## BTC Paper Trading — Critical Bug Found & Fixed

### PnL Calculation Bug (MAJOR)
- **Bug:** `close()` function flipped PnL sign for NO trades (`if dir == 'NO': pnl = -pnl`)
- **Impact:** All NO direction trades showed inverted PnL — losses displayed as profits
- **Discovery:** Jason asked why entry > exit showed profit. Balance check confirmed: balance $997.86 but PnL reported +$2.14 (actual -$2.14)
- **Fixed in:** v6 and v10 — removed the `-pnl` flip for NO direction
- **Lesson:** Always cross-check PnL against balance changes

### Strategy Performance (Corrected, All Historical Data)
After fixing PnL bug, recalculated ALL versions:

**delay_arb — THE ONLY PROFITABLE STRATEGY:**
- v6: 86笔, 55.8% WR, +$45.27, 盈亏比 3.15x
- v7: 35笔, 65.7% WR, +$23.23, 盈亏比 4.03x (BEST parameters)
- v8: 29笔, 48.3% WR, +$4.10, 盈亏比 1.36x
- v9: 13笔, 46.2% WR, -$3.50, 盈亏比 0.56x
- Total across versions: 163笔, +$69.10

**mean_reversion_high — LOSING in ALL versions:**
- v6: 153笔, 7.2% real WR, -$29.60 (was showing +$29.60 due to bug!)
- v7: 277笔, 32.1% WR, -$40.70
- v8: 357笔, 3.9% WR, -$61.50
- v9: 84笔, 8.3% WR, -$13.60

**mean_reversion_low — Also losing:** v6: 180笔, -$44.45

### V7 Has Best delay_arb Parameters
- Momentum threshold: 0.20% (v6 uses 0.15% = more noise)
- Hold timeout: 3min (v6 uses 6min = bigger losses)
- Highest win rate (65.7%) + best profit factor (4.03x)
- Jason asked to compare — recommended adopting V7 params

### Actions Taken
1. Stopped v7, v9 (enough data, both losing)
2. Disabled mean_reversion_low in v6 (first round)
3. Discovered PnL bug → disabled mean_reversion_high too
4. Fixed PnL bug in v6 and v10
5. Restarted both — now only running delay_arb
6. Updated cron reports to track v6 vs v10

### v10 Created & Running
- New features: WebSocket mode, flash crash detection, dynamic position sizing
- WebSocket connected successfully after fixing RSA auth (PSS + DIGEST_LENGTH salt, message format: `{timestamp}{METHOD}/trade-api/ws/v2`)
- Flash crash detection kept for logging only (not trading, since mean_rev is losing)
- Mean reversion disabled in v10 too

### Kalshi API Auth
- API Key configured: e23e4c65-... (read-only)
- Private key: /opt/kalshi_private_key.pem
- Env vars: KALSHI_API_KEY, KALSHI_PRIVATE_KEY_PATH in /opt/clawdbot.env
- Signing: RSA-PSS with SHA256, DIGEST_LENGTH salt
- Message format: `{timestamp_ms}{METHOD}/trade-api/v2{path}` (for REST) or `/trade-api/ws/v2` (for WS)
- Public endpoints (markets, exchange status) work without auth
- Portfolio/balance needs auth
- WebSocket needs auth (401 without)

### External Research Done
- Researched GitHub projects for Kalshi/prediction market trading bots
- Key findings in btc-arbitrage/RESEARCH-EXTERNAL.md
- Multiple projects validate delay arbitrage approach
- pmxt (457★) and dr-manhattan (137★) provide unified APIs
- WebSocket monitoring confirmed as best practice

### Kalshi Positions (unchanged)
- GDP >2.5% YES: 入场85¢, 现83¢ (-$0.66)
- GDP >5% NO: 入场89¢, 现89¢ ($0)
- CPI >0.0% YES: 入场94¢, 现93¢ (-$0.52)
- Total P&L: -$1.18 | Next settlement: CPI Feb 11

### Process Cleanup
- Killed zombie processes from Feb02 (settlement_tracker, collect_data_24h)
- Two root processes (54477, 60299) need Jason to `sudo kill -9`
- Cleaned managed process registry (removed dead v7, v9 entries)

### Cron Jobs
- All 11 jobs running normally
- BTC reports updated to compare v6 vs v10
- 30min update + 12h report both include v10 now
